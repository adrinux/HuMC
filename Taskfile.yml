version: '2'

#include: Taskvars.yml

tasks:

# Setup web-mc
  setup:
    cmds:
      - echo 'Starting'
      - task: hugo-installed
      - task: node-setup
      - task: node-setup-theme
      - echo 'Finished setup task'


  # Install node_modules
  node-setup:
    deps:
      - node-installed
    desc: Run npm install if node_modules doesn't exist
    cmds:
      - npm install
    status:
      - test -d node_modules

  # Install node_modules in theme
  node-setup-theme:
    deps:
      - node-setup
    dir: sites/test-site/themes/bunait
    desc: Symlink main node_modules in bunait theme and run npm install
    cmds:
      - ln -s ../../../../node_modules node_modules
      - npm install
    status:
      - test -d node_modules

  # Check if node installed
  node-installed:
    silent: true
    cmds:
      - |
        if ! command -v node > /dev/null; then
          echo "node is not installed. aborting."
          exit 1
        fi
      - echo "node installed, ok."

  hugo-installed:
    silent: true
    cmds:
      - |
        if ! command -v hugo > /dev/null; then
          echo "hugo is not installed. aborting."
          exit 1
        fi
      - echo "hugo installed, ok."


# Sites
# Copy existing test-site to new name
# how to pass in name? config file? Taskvars.yml can list global variables
# seems like the place for site config
# could also have sites/sitename/Taskvars.yml

  sites:
    cmds:
      - echo {{ .SITE_NAME }}


# Copy starter to new site with new name
  new-site:
    cmds:
      - echo 'Creating new site' {{ .NAME }}
      - cp -rn sites/test-site sites/{{ .NAME }}
      - mv -n sites/{{ .NAME }}/themes/bunait sites/{{ .NAME }}/themes/{{ .NAME }}
      - echo 'Searching new sites/NAME and replace bunait with NAME'
      - echo 'Add sites/NAME to .gitignore'
      - echo 'Init new git repo in sites/Name'
      - echo 'Finished creating site' {{ .NAME }}
      - echo 'New git repo created, add a remote and push'
# Notes:
# For 'cp' and 'mv'
# -r is recursive
# -n will not overwrite existing
# -v is verbose

